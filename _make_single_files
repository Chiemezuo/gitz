#!/usr/bin/env python3

from pathlib import Path
import datetime
import os
import stat
import sys

COMMANDS = 'list', 'write'
PYTHON_HASH_BANG = '#!/usr/bin/env python'
BASE = Path('single_files/')
TIMESTAMP_FORMAT = ' at %H:%M:%S'
AUTOGEN = """
# Automatically generated on {now:%Y-%m-%d} at {now:%H:%M:%S} by {program}
# DO NOT EDIT THIS FILE BY HAND

"""


def make_single_files(command='write'):
    if not command:
        raise ValueError('Missing command')

    if command not in COMMANDS:
        raise ValueError('No such command', command)

    files = (f for f in Path().iterdir() if f.name.startswith('git-'))
    if command == 'list':
        files = [f for f in files if _is_python_file(f)]
        files += [BASE / f.name for f in files]
        print(*files)
    else:
        for f in files:
            target = BASE / f.name
            if _is_python_file(f):
                _copy_python(f, target)
                print('Generated', f)
            else:
                _copy_bash(f, target)
                print('Copied   ', f)
            st = f.stat()
            os.chown(target, st[stat.ST_UID], st[stat.ST_GID])
            os.chmod(target, st.st_mode)


def _autogen():
    now = datetime.datetime.utcnow()
    program = Path(sys.argv[0]).name
    return AUTOGEN.format(**locals())


def _copy_bash(source, target):
    with open(target, 'w') as fp:
        for i, line in enumerate(open(source)):
            fp.write(line)
            if not i:
                fp.write(_autogen())


def _copy_python(source, target):
    gitz_begin = gitz_end = False
    gitz_code = open('_gitz.py').read()

    with open(target, 'w') as fp:
        for line in open(source):
            if gitz_end:
                fp.write(line)

            elif '_gitz' in line:
                gitz_begin = True

            elif gitz_begin:
                gitz_end = True
                fp.write(_autogen())
                fp.write(gitz_code)
                fp.write('\n\n')

            else:
                fp.write(line)


def _is_python_file(filename):
    return next(open(filename)).startswith(PYTHON_HASH_BANG)


if __name__ == '__main__':
    make_single_files(*sys.argv[1:])
