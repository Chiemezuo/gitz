#!/usr/bin/env python3
import _gitz
from pathlib import Path
import sys

USAGE = """
git-all: Perform a command on each of multiple branches or directories

USAGE:
    git all [name ...] - <command> [argument ...]

Performs <command> [argument ...] for each `name`, or over all branches if no
`name` is given.


EXAMPLES:
    git all - git log --online -5
    git all * - git all - git log --online -5

"""

EXIT = _gitz.Exit(USAGE)


def git_all(argv):
    with EXIT.on_exception('No - found in arguments'):
        dash_index = argv.index('-')
    names = argv[:dash_index]

    with EXIT.on_exception('No command found after - in arguments'):
        command, *args = argv[dash_index + 1:]

    if _gitz.find_git_root(Path()):
        if not _gitz.clean_workspace():
            EXIT.exit('Your local changes would be overwritten')
        branch, branches = _gitz.current_branch(), _gitz.branches()
    else:
        branch, branches = None, []

    cwd = Path().absolute()
    for name in names or branches:
        if name in branches:
            _gitz.git('checkout', name)
            try:
                pass
            finally:
                _gitz.git('checkout', branch)

        else:
            directory = Path(name)
            if not directory.is_dir():
                EXIT.exit(directory, 'is neither a branch nor a git repository')



if __name__ == '__main__':
    git_all(sys.argv[1:])
