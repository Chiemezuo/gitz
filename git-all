#!/usr/bin/env python3
from pathlib import Path
import sys
import _gitz

GIT = _gitz.GIT
EXIT = _gitz.Exit("""
git-all: Perform a command on each of multiple branches or directories

USAGE:
    git all [name ...] - <command> [argument ...]

Performs <command> [argument ...] for each `name`, or over all branches if no
`name` is given.


EXAMPLES:
    git all - git log --online -5
    git all * - git all - git log --online -5

""")


def git_all():
    EXIT.exit_on_help()
    argv = sys.argv[1:]

    with EXIT.on_exception('No - found in arguments'):
        dash_index = argv.index('-')
    names = argv[:dash_index]

    with EXIT.on_exception('No command found after - in arguments'):
        command, *args = argv[dash_index + 1:]

    branches = GIT.branches() if GIT.find_root() else []
    if branches and GIT.is_workspace_dirty():
        EXIT.exit('Your local changes would be overwritten')
    names = names or branches

    errors = [n for n in names if not (n in branches or Path(n).is_dir())]
    if errors:
        errors = '"%s"' % '", "'.join(errors)
        verb = 'are' if len(errors) > 1 else 'is'
        EXIT.exit(errors, verb, 'neither a branch nor a git repository')

    set_and_revert = _gitz.SetAndRevert.DIRECTORY, _gitz.SetAndRevert.BRANCH
    for name in names:
        with set_and_revert[name in branches](name):
            _gitz.run(command, *args)
