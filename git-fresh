#!/usr/bin/env python3
from gitz import git_functions
from gitz import program
from gitz.env import ENV
from gitz.git import GIT

USAGE = """\
git-fresh: Create and push a fresh branch from a reference branch

USAGE:
    git fresh <branch-name> [...<branch-name>]
"""

HELP = """

"""
PROGRAM = program.Program(USAGE, HELP)


def git_fresh():
    PROGRAM.check_help()

    if not PROGRAM.argv:
        PROGRAM.error_and_usage_and_exit('No branch name')

    PROGRAM.check_clean_workspace()
    for branch in PROGRAM.argv:
        _run_fresh(branch)


def _run_fresh(fresh_branch):
    branches = git_functions.branches()
    if fresh_branch in branches:
        PROGRAM.error('Branch name', fresh_branch, 'already exists')

    remotes = GIT.remote()
    if len(remotes) == 1:
        origin = upstream = remotes[0]
    else:
        origin = ENV.origin()[0]
        if origin not in remotes:
            PROGRAM.error('Unknown origin', origin)

        upstream = next((u for u in ENV.upstream() if u in remotes), None)
        if upstream is None:
            PROGRAM.error('No upstream found')

    if PROGRAM.called.get('error'):
        PROGRAM.exit()

    GIT.fetch(upstream)

    for branch in ENV.reference_branches():
        refspec = '%s/%s' % (upstream, branch)
        if git_functions.exists(refspec):
            GIT.checkout('-b', fresh_branch, refspec)
            GIT.push('-u', origin, fresh_branch)
            return

    PROGRAM.error_and_exit('No reference branch found')


if __name__ == '__main__':
    git_fresh()
